generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Post {
  id          Int      @id @default(autoincrement())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])

  @@index([name])
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String      @id @default(cuid())
  name          String?
  email         String      @unique
  emailVerified DateTime?
  image         String?
  password      String
  gender        String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  username      String      @unique
  accounts      Account[]
  characters    Character[]
  player        Player?
  posts         Post[]
  sessions      Session[]
}

model Character {
  id             String    @id @default(cuid())
  userId         String
  name           String
  level          Int       @default(1)
  vitality       Int       @default(5)
  strength       Int       @default(5)
  speed          Int       @default(5)
  dexterity      Int       @default(5)
  maxStamina     Int
  currentStamina Int
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  currentHp      Int
  deaths         Int       @default(0)
  floor          Int       @default(1)
  gender         String
  location       String    @default("Town Square")
  maxHp          Int
  deathAt        DateTime?
  deathReason    String?
  user           User      @relation(fields: [userId], references: [id])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Player {
  id                         String              @id @default(cuid())
  userId                     String              @unique
  characterName              String              @unique
  level                      Int                 @default(1)
  experience                 Int                 @default(0)
  gold                       Int                 @default(0)
  deathCount                 Int                 @default(0)
  isDeleted                  Boolean             @default(false)
  createdAt                  DateTime            @default(now())
  updatedAt                  DateTime            @updatedAt
  bankAccount                BankAccount?
  combatLogs                 CombatLog[]
  deathLogs                  DeathLog[]
  equipment                  Equipment?
  guildMember                GuildMember?
  inventory                  InventoryItem[]
  position                   MapPosition?
  marketListings             MarketListing[]
  marketTransactionsAsBuyer  MarketTransaction[] @relation("Buyer")
  marketTransactionsAsSeller MarketTransaction[] @relation("Seller")
  occupation                 Occupation?
  user                       User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  skills                     PlayerSkill[]
  stats                      PlayerStats?

  @@index([characterName])
  @@index([userId])
}

model PlayerStats {
  id         String   @id @default(cuid())
  playerId   String   @unique
  vitality   Int      @default(10)
  strength   Int      @default(10)
  speed      Int      @default(10)
  dexterity  Int      @default(10)
  maxHP      Int      @default(100)
  currentHP  Int      @default(100)
  maxSP      Int      @default(50)
  currentSP  Int      @default(50)
  statPoints Int      @default(0)
  updatedAt  DateTime @updatedAt
  player     Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
}

model MapTile {
  id           Int           @id @default(autoincrement())
  x            Int
  y            Int
  tileType     TileType
  zoneType     ZoneType
  isSafeZone   Boolean       @default(false)
  hasResource  Boolean       @default(false)
  resourceType ResourceType?
  description  String?
  encounters   Encounter[]
  positions    MapPosition[]
  npcs         NPC[]

  @@unique([x, y])
  @@index([x, y])
  @@index([tileType])
  @@index([zoneType])
}

model MapPosition {
  id        String   @id @default(cuid())
  playerId  String   @unique
  tileX     Int
  tileY     Int
  tileId    Int?
  updatedAt DateTime @updatedAt
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  tile      MapTile? @relation(fields: [tileId], references: [id])

  @@index([tileX, tileY])
}

model NPC {
  id        String     @id @default(cuid())
  name      String
  npcType   NPCType
  tileX     Int
  tileY     Int
  tileId    Int?
  dialogue  String?
  createdAt DateTime   @default(now())
  tile      MapTile?   @relation(fields: [tileId], references: [id])
  quests    Quest[]
  shopItems ShopItem[]

  @@index([tileX, tileY])
  @@index([npcType])
  @@index([tileId])
}

model ShopItem {
  id        String   @id @default(cuid())
  npcId     String
  itemId    String
  price     Int
  stock     Int?
  createdAt DateTime @default(now())
  item      Item     @relation(fields: [itemId], references: [id])
  npc       NPC      @relation(fields: [npcId], references: [id], onDelete: Cascade)
}

model Item {
  id                   String              @id @default(cuid())
  name                 String
  description          String?
  itemType             ItemType
  itemRarity           ItemRarity
  tier                 Int                 @default(1)
  value                Int
  stackable            Boolean             @default(false)
  maxStack             Int                 @default(1)
  equipmentSlot        EquipmentSlot?
  vitalityBonus        Int                 @default(0)
  strengthBonus        Int                 @default(0)
  speedBonus           Int                 @default(0)
  dexterityBonus       Int                 @default(0)
  hpBonus              Int                 @default(0)
  spBonus              Int                 @default(0)
  createdAt            DateTime            @default(now())
  bankVaultItems       BankVaultItem[]
  equippedAsAccessory1 Equipment[]         @relation("Accessory1")
  equippedAsAccessory2 Equipment[]         @relation("Accessory2")
  equippedAsChest      Equipment[]         @relation("Chest")
  equippedAsFeet       Equipment[]         @relation("Feet")
  equippedAsHead       Equipment[]         @relation("Head")
  equippedAsLegs       Equipment[]         @relation("Legs")
  equippedAsWeapon     Equipment[]         @relation("Weapon")
  inventoryItems       InventoryItem[]
  marketListings       MarketListing[]
  marketTransactions   MarketTransaction[]
  shopItems            ShopItem[]

  @@index([itemType])
  @@index([itemRarity])
  @@index([tier])
}

model InventoryItem {
  id        String   @id @default(cuid())
  playerId  String
  itemId    String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  item      Item     @relation(fields: [itemId], references: [id])
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([itemId])
}

model Equipment {
  id           String   @id @default(cuid())
  playerId     String   @unique
  weaponId     String?
  headId       String?
  chestId      String?
  legsId       String?
  feetId       String?
  accessory1Id String?
  accessory2Id String?
  updatedAt    DateTime @updatedAt
  accessory1   Item?    @relation("Accessory1", fields: [accessory1Id], references: [id])
  accessory2   Item?    @relation("Accessory2", fields: [accessory2Id], references: [id])
  chest        Item?    @relation("Chest", fields: [chestId], references: [id])
  feet         Item?    @relation("Feet", fields: [feetId], references: [id])
  head         Item?    @relation("Head", fields: [headId], references: [id])
  legs         Item?    @relation("Legs", fields: [legsId], references: [id])
  player       Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  weapon       Item?    @relation("Weapon", fields: [weaponId], references: [id])
}

model Occupation {
  id           String               @id @default(cuid())
  playerId     String               @unique
  primaryJob   PrimaryOccupation?
  secondaryJob SecondaryOccupation?
  level        Int                  @default(1)
  experience   Int                  @default(0)
  updatedAt    DateTime             @updatedAt
  player       Player               @relation(fields: [playerId], references: [id], onDelete: Cascade)
}

model PlayerSkill {
  id         String   @id @default(cuid())
  playerId   String
  skillName  String
  level      Int      @default(1)
  experience Int      @default(0)
  createdAt  DateTime @default(now())
  player     Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, skillName])
  @@index([playerId])
}

model Encounter {
  id         String      @id @default(cuid())
  tileX      Int
  tileY      Int
  tileId     Int?
  enemyType  String
  enemyLevel Int
  isActive   Boolean     @default(true)
  createdAt  DateTime    @default(now())
  combatLogs CombatLog[]
  tile       MapTile?    @relation(fields: [tileId], references: [id])

  @@index([tileX, tileY])
  @@index([tileId])
  @@index([isActive])
}

model CombatLog {
  id          String     @id @default(cuid())
  playerId    String
  encounterId String?
  turnNumber  Int
  action      String
  result      String
  createdAt   DateTime   @default(now())
  encounter   Encounter? @relation(fields: [encounterId], references: [id])
  player      Player     @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([encounterId])
}

model DeathLog {
  id         String   @id @default(cuid())
  playerId   String
  deathCount Int
  cause      String?
  locationX  Int?
  locationY  Int?
  createdAt  DateTime @default(now())
  player     Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
}

model DeathRecord {
  id            String   @id @default(cuid())
  characterName String
  userId        String?
  floorReached  Int
  causeOfDeath  String
  deathsUsed    Int
  createdAt     DateTime @default(now())
}

model Guild {
  id          String        @id @default(cuid())
  name        String        @unique
  description String?
  level       Int           @default(1)
  gold        Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  bank        GuildBank?
  members     GuildMember[]
  quests      GuildQuest[]

  @@index([name])
}

model GuildMember {
  id       String    @id @default(cuid())
  playerId String    @unique
  guildId  String
  role     GuildRole @default(MEMBER)
  joinedAt DateTime  @default(now())
  guild    Guild     @relation(fields: [guildId], references: [id], onDelete: Cascade)
  player   Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([guildId])
}

model GuildBank {
  id        String   @id @default(cuid())
  guildId   String   @unique
  gold      Int      @default(0)
  updatedAt DateTime @updatedAt
  guild     Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
}

model GuildQuest {
  id          String   @id @default(cuid())
  guildId     String
  title       String
  description String
  reward      String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  guild       Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@index([guildId])
  @@index([isActive])
}

model BankAccount {
  id         String          @id @default(cuid())
  playerId   String          @unique
  gold       Int             @default(0)
  vaultLevel Int             @default(1)
  updatedAt  DateTime        @updatedAt
  player     Player          @relation(fields: [playerId], references: [id], onDelete: Cascade)
  vaultItems BankVaultItem[]
}

model BankVaultItem {
  id        String      @id @default(cuid())
  accountId String
  itemId    String
  quantity  Int         @default(1)
  createdAt DateTime    @default(now())
  account   BankAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  item      Item        @relation(fields: [itemId], references: [id])

  @@index([accountId])
  @@index([itemId])
}

model MarketListing {
  id           String              @id @default(cuid())
  playerId     String
  itemId       String
  quantity     Int
  pricePerUnit Int
  totalPrice   Int
  listingTax   Int
  isActive     Boolean             @default(true)
  expiresAt    DateTime?
  createdAt    DateTime            @default(now())
  soldAt       DateTime?
  item         Item                @relation(fields: [itemId], references: [id])
  player       Player              @relation(fields: [playerId], references: [id], onDelete: Cascade)
  transactions MarketTransaction[]

  @@index([playerId])
  @@index([itemId])
  @@index([isActive])
  @@index([expiresAt])
}

model MarketTransaction {
  id         String        @id @default(cuid())
  listingId  String
  buyerId    String
  sellerId   String
  itemId     String
  quantity   Int
  totalPrice Int
  createdAt  DateTime      @default(now())
  buyer      Player        @relation("Buyer", fields: [buyerId], references: [id], onDelete: Cascade)
  item       Item          @relation(fields: [itemId], references: [id])
  listing    MarketListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  seller     Player        @relation("Seller", fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([buyerId])
  @@index([sellerId])
  @@index([listingId])
  @@index([itemId])
}

model Quest {
  id           String    @id @default(cuid())
  npcId        String?
  title        String
  description  String
  questType    QuestType
  reward       String?
  requirements String?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  npc          NPC?      @relation(fields: [npcId], references: [id])

  @@index([npcId])
  @@index([isActive])
  @@index([questType])
}

enum TileType {
  GRASS
  FOREST
  MOUNTAIN
  RIVER
  DESERT
  DUNGEON
  TOWN
  SHRINE
  ROAD
}

enum ZoneType {
  SAFE
  LOW_DANGER
  MEDIUM_DANGER
  HIGH_DANGER
  EXTREME_DANGER
}

enum ResourceType {
  ORE
  HERB
  FISH
  WOOD
  RARE_ITEM
}

enum NPCType {
  MERCHANT
  QUEST_GIVER
  TRAINER
  BANKER
  GUILD_MASTER
  GUARD
  TAVERN_KEEPER
}

enum ItemType {
  WEAPON
  ARMOR
  ACCESSORY
  CONSUMABLE
  MATERIAL
  QUEST_ITEM
  TOOL
}

enum ItemRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum EquipmentSlot {
  WEAPON
  HEAD
  CHEST
  LEGS
  FEET
  ACCESSORY_1
  ACCESSORY_2
}

enum PrimaryOccupation {
  BLACKSMITH
  ALCHEMIST
  COOK
  TAILOR
  MERCHANT
  BEAST_HANDLER
}

enum SecondaryOccupation {
  MINER
  HERBALIST
  FISHER
  LOGGER
  FORAGER
}

enum GuildRole {
  LEADER
  OFFICER
  MEMBER
}

enum QuestType {
  KILL
  GATHER
  DELIVER
  EXPLORE
  CRAFT
}
